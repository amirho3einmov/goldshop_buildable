     name: Install Android SDK cmdline-tools, platform-tools, build-tools and NDK (robust, safer)
      id: install_sdk
      run: |
        set -euo pipefail

        export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        export PATH="$ANDROID_SDK_ROOT/platform-tools:$PATH"
        sudo mkdir -p "$ANDROID_SDK_ROOT"
        sudo chown -R "$USER":"$USER" "$ANDROID_SDK_ROOT" || true

        # Try to find sdkmanager first
        if command -v sdkmanager >/dev/null 2>&1; then
          SDKMANAGER_CMD="$(command -v sdkmanager)"
          echo "Using existing sdkmanager: $SDKMANAGER_CMD"
        else
          TMP_ZIP="/tmp/cmdline-tools.zip"
          URL="https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip"
          echo "Downloading Android commandline tools from $URL"
          curl -fsSL --retry 3 --retry-delay 5 -o "$TMP_ZIP" "$URL"

          TMP_UNPACK="/tmp/cmdline-tools-unpack-$$"
          mkdir -p "$TMP_UNPACK"
          unzip -q "$TMP_ZIP" -d "$TMP_UNPACK"

          TARGET_DIR="$ANDROID_SDK_ROOT/cmdline-tools/latest"
          if [ -d "$TARGET_DIR" ] && [ "$(ls -A "$TARGET_DIR")" ]; then
            echo "Removing existing $TARGET_DIR to avoid mv conflict"
            sudo rm -rf "$TARGET_DIR"
          fi
          sudo mkdir -p "$TARGET_DIR"
          # move extracted content into target
          if [ -d "$TMP_UNPACK/cmdline-tools" ]; then
            sudo mv "$TMP_UNPACK/cmdline-tools/"* "$TARGET_DIR/"
          else
            sudo mv "$TMP_UNPACK/"* "$TARGET_DIR/" || true
          fi
          rm -rf "$TMP_UNPACK" "$TMP_ZIP"
          SDKMANAGER_CMD="$TARGET_DIR/bin/sdkmanager"
          echo "Installed cmdline-tools to $TARGET_DIR"
        fi

        chmod +x "$SDKMANAGER_CMD" || true
        echo "sdkmanager location: $SDKMANAGER_CMD"

        # Install required items (explicit calls). If sdkmanager fails transiently, retry each call.
        install_pkg() {
          local pkg="$1"
          local n=0
          until [ $n -ge 4 ]; do
            echo "Installing $pkg (attempt $((n+1)))..."
            if yes | "$SDKMANAGER_CMD" --sdk_root="$ANDROID_SDK_ROOT" "$pkg"; then
              return 0
           
