on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          set -e

          # enable universe and update (software-properties-common برای add-apt-repository)
          sudo apt-get update
          sudo apt-get install -y software-properties-common || true
          sudo add-apt-repository -y universe || true
          sudo apt-get update

          # معمولی‌ترین وابستگی‌ها
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            git \
            build-essential \
            zip \
            unzip \
            openjdk-17-jdk \
            autoconf \
            automake \
            libtool \
            pkg-config \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            libtinfo6 \
            cmake \
            curl \
            wget \
            python3 \
            python3-pip \
            python3-venv \
            python3-distutils || true

          # تلاش کنیم libtinfo5 نصب بشه؛ در صورت عدم وجود، fallback به libncurses5 یا دانلود .deb
          if ! dpkg -s libtinfo5 >/dev/null 2>&1; then
            echo "Trying to install libtinfo5 from repos..."
            if sudo apt-get install -y libtinfo5; then
              echo "libtinfo5 installed from repo."
            else
              echo "libtinfo5 not available from repos — trying libncurses5..."
              if sudo apt-get install -y libncurses5; then
                echo "libncurses5 installed (provides compatible libtinfo symbols)."
              else
                echo "libncurses5 not available either — downloading libtinfo5 .deb as fallback..."
                wget -q http://security.ubuntu.com/ubuntu/pool/universe/n/ncurses/libtinfo5_6.3-2ubuntu0.1_amd64.deb -O libtinfo5.deb
                sudo apt-get install -y ./libtinfo5.deb || (sudo dpkg -i libtinfo5.deb || true)
                sudo apt-get install -f -y || true
                rm -f libtinfo5.deb
              fi
            fi
          else
            echo "libtinfo5 already present."
          fi

            

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: 'build-tools;28.0.1'

      - name: Build APK
        uses: digreatbrian/buildozer-action@v2
        with:
          python-version: 3.8
          buildozer-cmd: buildozer -v android debug

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: package
          path: ./bin/*.apk
