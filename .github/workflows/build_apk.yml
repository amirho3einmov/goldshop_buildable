name: Build APK (fixed AIDL issue)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Java (OpenJDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install system packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git python3-pip python3-dev build-essential unzip zip \
            libncurses-dev libtinfo-dev libssl-dev libffi-dev liblzma-dev libbz2-dev zlib1g-dev \
            autoconf automake libtool pkg-config curl ca-certificates

      - name: Install Android SDK and NDK
        env:
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
        run: |
          set -e
          sudo mkdir -p $ANDROID_SDK_ROOT
          sudo chown -R $USER:$USER $ANDROID_SDK_ROOT

          cd /tmp
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools/latest
          unzip -q commandlinetools-linux-9477386_latest.zip -d $ANDROID_SDK_ROOT/cmdline-tools/latest
          if [ -d "$ANDROID_SDK_ROOT/cmdline-tools/latest/cmdline-tools" ]; then
            mv $ANDROID_SDK_ROOT/cmdline-tools/latest/cmdline-tools/* $ANDROID_SDK_ROOT/cmdline-tools/latest/
            rm -rf $ANDROID_SDK_ROOT/cmdline-tools/latest/cmdline-tools
          fi
          rm -f commandlinetools-linux-9477386_latest.zip

          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"

          sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools" "platforms;android-33" "build-tools;33.0.2" "ndk;25.2.9519653"

          yes | sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses || true

          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/25.2.9519653" >> $GITHUB_ENV

          echo "$ANDROID_SDK_ROOT/build-tools/33.0.2" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH

          if [ -f "$ANDROID_SDK_ROOT/build-tools/33.0.2/aidl" ]; then
            sudo ln -sf "$ANDROID_SDK_ROOT/build-tools/33.0.2/aidl" /usr/local/bin/aidl
            sudo chmod +x "$ANDROID_SDK_ROOT/build-tools/33.0.2/aidl"
          fi

          echo "=== AIDL check ==="
          which aidl || true
          ls -la $ANDROID_SDK_ROOT/build-tools/33.0.2/ | head -20
          $ANDROID_SDK_ROOT/build-tools/33.0.2/aidl --version || echo "aidl version check failed"

      - name: Set up Python virtual environment
        run: |
          python3 -m venv buildozer-venv
          source buildozer-venv/bin/activate
          echo "VIRTUAL_ENV=$PWD/buildozer-venv" >> $GITHUB_ENV
          echo "$PWD/buildozer-venv/bin" >> $GITHUB_PATH

      - name: Install buildozer & python deps
        run: |
          source buildozer-venv/bin/activate
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install --upgrade Cython virtualenv
          python3 -m pip install --upgrade buildozer
          buildozer --version

      - name: Configure buildozer environment
        run: |
          echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/25.2.9519653" >> $GITHUB_ENV
          echo "ANDROID_HOME=/usr/local/lib/android/sdk" >> $GITHUB_ENV

          mkdir -p $HOME/.buildozer
          # create android_env.sh using echo lines (no heredoc)
          echo 'export ANDROID_SDK_ROOT="/usr/local/lib/android/sdk"' > $HOME/.buildozer/android_env.sh
          echo 'export ANDROID_NDK_HOME="/usr/local/lib/android/sdk/ndk/25.2.9519653"' >> $HOME/.buildozer/android_env.sh
          echo 'export ANDROID_HOME="/usr/local/lib/android/sdk"' >> $HOME/.buildozer/android_env.sh
          echo 'export PATH="/usr/local/lib/android/sdk/build-tools/33.0.2:$PATH"' >> $HOME/.buildozer/android_env.sh
          echo 'export PATH="/usr/local/lib/android/sdk/platform-tools:$PATH"' >> $HOME/.buildozer/android_env.sh
          echo 'export PATH="/usr/local/lib/android/sdk/cmdline-tools/latest/bin:$PATH"' >> $HOME/.buildozer/android_env.sh
          chmod +x $HOME/.buildozer/android_env.sh

      - name: Create proper buildozer.spec
        run: |
          if [ ! -f buildozer.spec ]; then
            buildozer init
          fi

          # create buildozer.spec via echo lines to avoid heredoc indentation issues
          echo '[app]' > buildozer.spec
          echo 'title = MyApp' >> buildozer.spec
          echo 'package.name = myapp' >> buildozer.spec
          echo 'package.domain = org.mydomain' >> buildozer.spec
          echo 'source.dir = .' >> buildozer.spec
          echo 'source.include_exts = py,png,jpg,kv,atlas' >> buildozer.spec
          echo 'version = 0.1' >> buildozer.spec
          echo 'requirements = python3,kivy' >> buildozer.spec
          echo 'orientation = portrait' >> buildozer.spec
          echo 'osx.python_version = 3' >> buildozer.spec
          echo 'osx.kivy_version = 1.9.1' >> buildozer.spec
          echo 'fullscreen = 0' >> buildozer.spec
          echo '' >> buildozer.spec
          echo '[buildozer]' >> buildozer.spec
          echo 'log_level = 2' >> buildozer.spec
          echo 'warn_on_root = 1' >> buildozer.spec
          echo '' >> buildozer.spec
          echo '[app:android]' >> buildozer.spec
          echo 'android.sdk_path = /usr/local/lib/android/sdk' >> buildozer.spec
          echo 'android.ndk_path = /usr/local/lib/android/sdk/ndk/25.2.9519653' >> buildozer.spec
          echo 'android.ndk_version = 25b' >> buildozer.spec
          echo 'android.api = 33' >> buildozer.spec
          echo 'android.minapi = 21' >> buildozer.spec
          echo 'android.sdk_build_tools = 33.0.2' >> buildozer.spec
          echo 'android.accept_sdk_license = True' >> buildozer.spec
          echo 'android.allow_backup = True' >> buildozer.spec
          echo 'android.fast_async = True' >> buildozer.spec
          echo '' >> buildozer.spec
          echo 'p4a.branch = develop' >> buildozer.spec
          echo 'p4a.options = --dir=./' >> buildozer.spec
          echo '' >> buildozer.spec
          echo 'android.permissions = INTERNET,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE' >> buildozer.spec
          echo 'android.arch = arm64-v8a, armeabi-v7a' >> buildozer.spec

          echo "=== Final buildozer.spec ==="
          cat buildozer.spec

      - name: Prepare buildozer directories
        run: |
          export HOME="${GITHUB_WORKSPACE}"
          mkdir -p "$HOME/.buildozer"
          mkdir -p "$HOME/.buildozer/android/platform"
          mkdir -p "$HOME/.buildozer/android/platform/android-sdk"
          ln -sf /usr/local/lib/android/sdk/* "$HOME/.buildozer/android/platform/android-sdk/" || true
          mkdir -p "$HOME/.buildozer/android/platform/android-sdk/build-tools"
          ln -sf /usr/local/lib/android/sdk/build-tools/33.0.2 "$HOME/.buildozer/android/platform/android-sdk/build-tools/33.0.2" || true

      - name: Build APK (debug)
        env:
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
          ANDROID_HOME: /usr/local/lib/android/sdk
          ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/25.2.9519653
          HOME: ${{ github.workspace }}
        run: |
          source buildozer-venv/bin/activate
          source $HOME/.buildozer/android_env.sh

          echo "=== Environment Verification ==="
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
          echo "PATH: $PATH"

          echo "=== AIDL Verification ==="
          which aidl || echo "AIDL not in PATH"
          find /usr/local/lib/android/sdk -name "aidl" -type f 2>/dev/null | head -5
          if [ -f "/usr/local/lib/android/sdk/build-tools/33.0.2/aidl" ]; then
            echo "AIDL found at: /usr/local/lib/android/sdk/build-tools/33.0.2/aidl"
            /usr/local/lib/android/sdk/build-tools/33.0.2/aidl --version || echo "Could not get AIDL version"
          else
            echo "AIDL not found in expected location"
            find /usr/local/lib/android/sdk -name "aidl" -exec ls -la {} \; 2>/dev/null || echo "No AIDL found in SDK"
          fi

          echo "=== Build Tools Contents ==="
          ls -la /usr/local/lib/android/sdk/build-tools/33.0.2/ | head -10

          echo "=== Starting Buildozer ==="
          buildozer --version
          buildozer -v android debug

      - name: Upload APK artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: bin/*.apk
