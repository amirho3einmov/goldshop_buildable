name: Build APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup Python 3
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Setup Java (OpenJDK 17)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install system packages
      run: |
        sudo apt-get update -y
        sudo apt-get install -y git python3-dev build-essential unzip zip \
          libncurses-dev libtinfo-dev libssl-dev libffi-dev liblzma-dev libbz2-dev zlib1g-dev \
          autoconf automake libtool pkg-config

    - name: Install buildozer & python deps (system python)
      run: |
        # install buildozer and dependences using system python (not --user)
        python3 -m pip install --upgrade pip setuptools wheel
        python3 -m pip install --upgrade Cython virtualenv
        python3 -m pip install --upgrade buildozer
        # in some runners pip may install to user base; add it to PATH just in case
        export USER_BASE=$(python3 -m site --user-base)
        echo "USER_BASE=$USER_BASE"
        export PATH="$USER_BASE/bin:$PATH"
        which buildozer || python3 -m buildozer --version
        buildozer --version || true
        python3 -m pip list

    - name: Show repo files
      run: ls -la

    - name: Ensure buildozer.spec exists
      run: |
        if [ ! -f buildozer.spec ]; then
          echo "ERROR: buildozer.spec not found in repo root"
          ls -la
          exit 1
        fi

    - name: Prepare HOME for buildozer
      run: |
        # make sure HOME is writable and buildozer uses workspace for caches
        export HOME="${GITHUB_WORKSPACE}"
        mkdir -p "$HOME/.buildozer"
        echo "HOME set to: $HOME"
        ls -la "$HOME"

    - name: Build APK (debug)
      env:
        HOME: ${{ github.workspace }}
      run: |
        # ensure user-base bin is on PATH (if pip used --user)
        export PATH="$(python3 -m site --user-base)/bin:$PATH"
        echo "PATH: $PATH"
        # run buildozer with system python
        python3 -m buildozer -v android debug

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: apk
        path: bin/*.apk
