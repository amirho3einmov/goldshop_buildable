name: Build APK (fixed AIDL issue)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Java (OpenJDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install system packages (incl. rsync)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git python3-pip python3-dev build-essential unzip zip \
            libncurses-dev libtinfo-dev libssl-dev libffi-dev liblzma-dev libbz2-dev zlib1g-dev \
            autoconf automake libtool pkg-config curl ca-certificates rsync

      - name: Install Android SDK commandline-tools, platform-tools, build-tools and NDK
        env:
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
        run: |
          set -e

          # create SDK dir and give ownership to runner user
          sudo mkdir -p "$ANDROID_SDK_ROOT"
          sudo chown -R $USER:$USER "$ANDROID_SDK_ROOT"

          # download command line tools zip
          cd /tmp
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip

          # extract into temp dir to avoid overwriting existing contents
          TMPDIR=$(mktemp -d)
          unzip -q commandlinetools-linux-9477386_latest.zip -d "$TMPDIR"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"

          # normalize layout: some zips contain cmdline-tools/* top-level
          if [ -d "$TMPDIR/cmdline-tools" ]; then
            SRC_DIR="$TMPDIR/cmdline-tools"
          else
            SRC_DIR="$TMPDIR"
          fi

          # use rsync (preferred) to merge into place (avoids "Directory not empty" mv errors)
          if command -v rsync >/dev/null 2>&1; then
            rsync -a "$SRC_DIR/" "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
          else
            cp -a "$SRC_DIR/." "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
          fi

          # cleanup
          rm -rf "$TMPDIR"
          rm -f commandlinetools-linux-9477386_latest.zip

          # make sdkmanager available in current shell
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"

          # install platform-tools, platform, build-tools and NDK non-interactively
          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-33" "build-tools;33.0.2" "ndk;25.2.9519653"

          # accept licenses
          yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses || true

          # persist variables for next steps
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/25.2.9519653" >> $GITHUB_ENV

          # ensure build-tools/platform-tools/cmdline-tools are on PATH for later steps
          echo "$ANDROID_SDK_ROOT/build-tools/33.0.2" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH

          # symlink aidl into /usr/local/bin so it's resolvable as 'aidl'
          if [ -f "$ANDROID_SDK_ROOT/build-tools/33.0.2/aidl" ]; then
            sudo ln -sf "$ANDROID_SDK_ROOT/build-tools/33.0.2/aidl" /usr/local/bin/aidl
            sudo chmod +x "$ANDROID_SDK_ROOT/build-tools/33.0.2/aidl"
          fi

          # diagnostics
          echo "=== AIDL check ==="
          which aidl || true
          ls -la "$ANDROID_SDK_ROOT/build-tools/33.0.2/" | head -20
          "$ANDROID_SDK_ROOT/build-tools/33.0.2/aidl" --version || echo "aidl version check failed"

      - name: Set up Python virtual environment
        run: |
          python3 -m venv buildozer-venv
          source buildozer-venv/bin/activate
          echo "VIRTUAL_ENV=$PWD/buildozer-venv" >> $GITHUB_ENV
          echo "$PWD/buildozer-venv/bin" >> $GITHUB_PATH

      - name: Install buildozer & python deps
        run: |
          source buildozer-venv/bin/activate
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install --upgrade Cython virtualenv
          python3 -m pip install --upgrade buildozer
          buildozer --version

      - name: Configure buildozer environment
        run: |
          # Persist SDK/NDK paths again (redundant safe write)
          echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/25.2.9519653" >> $GITHUB_ENV
          echo "ANDROID_HOME=/usr/local/lib/android/sdk" >> $GITHUB_ENV

          mkdir -p $HOME/.buildozer

          # create android_env.sh via echo lines (no problematic heredoc indentation)
          echo 'export ANDROID_SDK_ROOT="/usr/local/lib/android/sdk"' > $HOME/.buildozer/android_env.sh
          echo 'export ANDROID_NDK_HOME="/usr/local/lib/android/sdk/ndk/25.2.9519653"' >> $HOME/.buildozer/android_env.sh
          echo 'export ANDROID_HOME="/usr/local/lib/android/sdk"' >> $HOME/.buildozer/android_env.sh
          echo 'export PATH="/usr/local/lib/android/sdk/build-tools/33.0.2:$PATH"' >> $HOME/.buildozer/android_env.sh
          echo 'export PATH="/usr/local/lib/android/sdk/platform-tools:$PATH"' >> $HOME/.buildozer/android_env.sh
          echo 'export PATH="/usr/local/lib/android/sdk/cmdline-tools/latest/bin:$PATH"' >> $HOME/.buildozer/android_env.sh
          chmod +x $HOME/.buildozer/android_env.sh

      - name: Create buildozer.spec (safe, no indented heredoc)
        run: |
          if [ ! -f buildozer.spec ]; then
            buildozer init
          fi

          cat > buildozer.spec <<'SPEC'
[app]
title = MyApp
package.name = myapp
package.domain = org.mydomain
source.dir = .
source.include_exts = py,png,jpg,kv,atlas
version = 0.1
requirements = python3,kivy
orientation = portrait
osx.python_version = 3
osx.kivy_version = 1.9.1
fullscreen = 0

[buildozer]
log_level = 2
warn_on_root = 1

[app:android]
android.sdk_path = /usr/local/lib/android/sdk
android.ndk_path = /usr/local/lib/android/sdk/ndk/25.2.9519653
android.ndk_version = 25b
android.api = 33
android.minapi = 21
android.sdk_build_tools = 33.0.2
android.accept_sdk_license = True
android.allow_backup = True
android.fast_async = True

p4a.branch = develop
p4a.options = --dir=./

android.permissions = INTERNET,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE
android.arch = arm64-v8a, armeabi-v7a
SPEC

          echo "=== Final buildozer.spec ==="
          cat buildozer.spec

      - name: Prepare buildozer directories (symlink SDK where buildozer expects)
        run: |
          export HOME="${GITHUB_WORKSPACE}"
          mkdir -p "$HOME/.buildozer"
          mkdir -p "$HOME/.buildozer/android/platform"
          mkdir -p "$HOME/.buildozer/android/platform/android-sdk"
          ln -sf /usr/local/lib/android/sdk/* "$HOME/.buildozer/android/platform/android-sdk/" || true
          mkdir -p "$HOME/.buildozer/android/platform/android-sdk/build-tools"
          ln -sf /usr/local/lib/android/sdk/build-tools/33.0.2 "$HOME/.buildozer/android/platform/android-sdk/build-tools/33.0.2" || true

      - name: Build APK (debug)
        env:
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
          ANDROID_HOME: /usr/local/lib/android/sdk
          ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/25.2.9519653
          HOME: ${{ github.workspace }}
        run: |
          source buildozer-venv/bin/activate
          source $HOME/.buildozer/android_env.sh

          echo "=== Environment Verification ==="
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
          echo "PATH: $PATH"

          echo "=== AIDL Verification ==="
          which aidl || echo "AIDL not in PATH"
          find /usr/local/lib/android/sdk -name "aidl" -type f 2>/dev/null | head -5
          if [ -f "/usr/local/lib/android/sdk/build-tools/33.0.2/aidl" ]; then
            echo "AIDL found at: /usr/local/lib/android/sdk/build-tools/33.0.2/aidl"
            /usr/local/lib/android/sdk/build-tools/33.0.2/aidl --version || echo "Could not get AIDL version"
          else
            echo "AIDL not found in expected location"
            find /usr/local/lib/android/sdk -name "aidl" -exec ls -la {} \; 2>/dev/null || echo "No AIDL found in SDK"
          fi

          echo "=== Build Tools Contents ==="
          ls -la /usr/local/lib/android/sdk/build-tools/33.0.2/ | head -10

          echo "=== Starting Buildozer ==="
          buildozer --version
          buildozer -v android debug

      - name: Upload APK artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: bin/*.apk
